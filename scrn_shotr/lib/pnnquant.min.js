(function(){function t(t){this.opts=t||{},this.hasSemiTransparency=!1,this.m_transparentPixelIndex=-1,this.m_transparentColor=0,this.palette=[],this.qPixels=[]}Math.clamp||(Math.clamp=function(t,r,e){return this.max(r,this.min(e,t))});var r=[],e=[];function n(){this.ac=this.rc=this.gc=this.bc=0,this.cnt=0,this.nn=this.fw=this.bk=this.tm=this.mtm=0,this.err=0}function a(t,r,e,n,a){return a?(240&t)<<8|(240&r)<<4|240&e|n>>4:(248&r)<<8|(252&e)<<3|n>>3}function i(t){return t*t}function s(t,r){for(var e=0,n=1e100,a=t[r],s=a.cnt,h=a.ac,o=a.rc,c=a.gc,l=a.bc,p=a.fw;0!=p;p=t[p].fw){var f=t[p].cnt,m=s*f/(s+f);if(!(m>=n)){var u=m*i(t[p].ac-h);u>=n||(u+=m*i(t[p].rc-o))>=n||(u+=m*i(t[p].gc-c))>=n||(u+=m*i(t[p].bc-l))>=n||(n=u,e=p)}}a.err=n,a.nn=e}function h(t,r,n){var a=e[n];if(null!=a)return a;for(var s=0,h=255&n,o=n>>>8&255,c=n>>>16&255,l=n>>>24&255,p=1e100,f=0;f<r;f++){var m=255&t[f],u=t[f]>>>8&255,v=t[f]>>>16&255,x=i((t[f]>>>24&255)-l);x>p||((x+=i(m-h))>p||(x+=i(u-o))>p||(x+=i(v-c))>p||(p=x,s=f))}return e[n]=s,s}function o(t,e,n){var a=0,i=255&n,s=n>>>8&255,h=n>>>16&255,o=n>>>24&255,c=r[n];if(!c){for((c=[])[2]=c[3]=1e100;a<e;a++){var l=255&t[a],p=t[a]>>>8&255,f=t[a]>>>16&255,m=t[a]>>>24&255;c[4]=Math.abs(o-m)+Math.abs(i-l)+Math.abs(s-p)+Math.abs(h-f),c[4]<c[2]?(c[1]=c[0],c[3]=c[2],c[0]=a,c[2]=c[4]):c[4]<c[3]&&(c[1]=a,c[3]=c[4])}1e100==c[3]&&(c[2]=0)}return a=0==c[2]||Math.floor(32769*Math.random())%(c[3]+c[2])<=c[3]?c[0]:c[1],r[n]=c,a}function c(t,r,e,n,a,i,s,h){var o=[];return h?(o[0]=a[(i[s]+4104>>4)+r],o[1]=a[(i[s+1]+4104>>4)+e],o[2]=a[(i[s+2]+4104>>4)+n],o[3]=a[(i[s+3]+4104>>4)+t],o):(o[0]=a[(i[s]+8208>>5)+r],o[1]=a[(i[s+1]+4104>>4)+e],o[2]=a[(i[s+2]+8208>>5)+n],o[3]=t,o)}t.prototype.pnnquan=function(t,r,e){for(var h=new Array(65536),o=0;o<t.length;++o){var c=255&t[o],l=t[o]>>>8&255,p=t[o]>>>16&255,f=a(A=t[o]>>>24&255,c,l,p,this.hasSemiTransparency);null==h[f]&&(h[f]=new n),h[f].ac+=A,h[f].rc+=c,h[f].gc+=l,h[f].bc+=p,h[f].cnt++}var m,u,v,x=0;for(o=0;o<h.length;++o)if(null!=h[o]){var g=1/h[o].cnt;h[o].ac*=g,h[o].rc*=g,h[o].gc*=g,h[o].bc*=g,h[x++]=h[o]}r<16&&(e=-1),i(r)/x<.022&&(e=0),e>0?h[0].cnt=0|Math.sqrt(h[0].cnt):e<0&&(h[0].cnt=0|Math.cbrt(h[0].cnt));for(o=0;o<x-1;++o)h[o].fw=o+1,h[o+1].bk=o,e>0?h[o+1].cnt=0|Math.sqrt(h[o+1].cnt):e<0&&(h[o+1].cnt=0|Math.cbrt(h[o+1].cnt));var d=new Uint32Array(65537);for(o=0;o<x;++o){s(h,o);var y=h[o].err;for(u=++d[0];u>1&&!(h[m=d[v=u>>1]].err<=y);u=v)d[u]=m;d[u]=o}var b=x-r;for(o=0;o<b;){for(var P;;){var w=d[1];if((P=h[w]).tm>=P.mtm&&h[P.nn].mtm<=P.tm)break;65535==P.mtm?w=d[1]=d[d[0]--]:(s(h,w),P.tm=o);y=h[w].err;for(u=1;(v=u+u)<=d[0]&&(v<d[0]&&h[d[v]].err>h[d[v+1]].err&&++v,!(y<=h[m=d[v]].err));u=v)d[u]=m;d[u]=w}var M=h[P.nn],q=P.cnt,_=M.cnt;g=1/(q+_);P.ac=g*(q*P.ac+_*M.ac),P.rc=g*(q*P.rc+_*M.rc),P.gc=g*(q*P.gc+_*M.gc),P.bc=g*(q*P.bc+_*M.bc),P.cnt+=M.cnt,P.mtm=++o,h[M.bk].fw=M.fw,h[M.fw].bk=M.bk,M.mtm=65535}delete d;var I=0;for(o=0;;++I){var A=Math.round(Math.clamp(h[o].ac,0,255));c=Math.round(Math.clamp(h[o].rc,0,255)),l=Math.round(Math.clamp(h[o].gc,0,255)),p=Math.round(Math.clamp(h[o].bc,0,255));if(this.palette[I]=A<<24|p<<16|l<<8|c,this.m_transparentPixelIndex>=0&&this.palette[I]==this.m_transparentColor){var U=this.palette[0];this.palette[0]=this.palette[I],this.palette[I]=U}if(0==(o=h[o].fw))break}void 0!==this.palette.sort&&this.palette.sort()},t.prototype.quantize_image=function(t,r,e,n,a){var i=r>256?new Uint16Array(t.length):new Uint8Array(t.length),s=0;if(a){const a=4,o=256,B=20;for(var l=(e+2)*a,p=new Uint32Array(a*o),f=new Uint32Array(2*o),m=0;m<o;++m)p[m]=0,p[m+o]=m,p[m+2*o]=255,p[m+3*o]=255,f[m]=-B,f[m+o]=B;for(m=-B;m<=B;++m)f[m+o]=m;var u=this.hasSemiTransparency||r<64,v=1,x=new Uint32Array(l),g=new Uint32Array(l);for(m=0;m<n;++m){v<0&&(s+=e-1);var d=a,y=e*a;g[y]=g[y+1]=g[y+2]=g[y+3]=0;for(var b=0;b<e;++b){var P=255&t[s],w=t[s]>>>8&255,M=t[s]>>>16&255,q=c(t[s]>>>24&255,P,w,M,p,x,d,u),_=q[0],I=q[1],A=q[2],U=q[3],k=U<<24|A<<16|I<<8|_;i[s]=h(this.palette,r,k);var T=this.palette[i[s]],C=T>>>8&255,S=T>>>16&255,z=T>>>24&255;_=f[_-(255&T)+o],I=f[I-C+o],A=f[A-S+o],U=f[U-z+o];var Q=2*_;g[y-a]=_,g[y+a]+=_+=Q,g[y]+=_+=Q,x[d+a]+=_+=Q,Q=2*I,g[y+1-a]=I,g[y+1+a]+=I+=Q,g[y+1]+=I+=Q,x[d+1+a]+=I+=Q,Q=2*A,g[y+2-a]=A,g[y+2+a]+=A+=Q,g[y+2]+=A+=Q,x[d+2+a]+=A+=Q,Q=2*U,g[y+3-a]=U,g[y+3+a]+=U+=Q,g[y+3]+=U+=Q,x[d+3+a]+=U+=Q,d+=a,y-=a,s+=v}m%2==1&&(s+=e+1),v*=-1;var j=x;x=g,g=j}return this.qPixels=i,this.qPixels}if(this.m_transparentPixelIndex>=0||r<64)for(m=0;m<this.qPixels.length;++m)i[m]=h(this.palette,r,t[m]);else for(m=0;m<this.qPixels.length;++m)i[m]=o(this.palette,r,t[m]);return this.qPixels=i,this.qPixels},t.prototype.quantizeImage=function(){for(var t=this.opts.pixels,n=this.opts.width,a=this.opts.height,i=this.opts.colors,s=this.opts.dithering,h=0;h<t.length;++h){var o=t[h]>>>24&255;o<255&&(this.hasSemiTransparency=!0,0==o&&(this.m_transparentPixelIndex=h,this.m_transparentColor=t[h]))}if(this.palette=new Uint32Array(i),i>2?this.pnnquan(t,i,1):this.m_transparentPixelIndex>=0?(this.palette[0]=0,this.palette[1]=255<<24):(this.palette[0]=255<<24,this.palette[1]=4294967295),this.qPixels=this.quantize_image(t,i,n,a,s),this.m_transparentPixelIndex>=0){var c=this.qPixels[this.m_transparentPixelIndex];if(i>2)this.palette[c]=this.m_transparentColor;else if(palette[c]!=this.m_transparentColor){var l=palette[0];this.palette[0]=palette[1],this.palette[1]=l}}return r=[],e=[],function(t,r){for(var e=new Uint32Array(r.length),n=0;n<r.length;++n)e[n]=t[r[n]];return e}(this.palette,this.qPixels)},t.prototype.getIndexedPixels=function(){return this.qPixels},t.prototype.getPalette=function(){return this.palette.buffer},t.prototype.getImgType=function(){return this.opts.colors>256||this.hasSemiTransparency?"image/png":"image/gif"},t.prototype.getTransparentIndex=function(){return this.m_transparentPixelIndex},this.PnnQuant=t,"undefined"!=typeof module&&module.exports&&(module.exports=t)}).call(this);